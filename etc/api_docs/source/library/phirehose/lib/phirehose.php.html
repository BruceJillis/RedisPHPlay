<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="generator" content="PHPDoctor 2RC4 (http://peej.github.com/phpdoctor/)">
<meta name="when" content="Sat, 02 Jul 2011 20:04:56 +0000">

<link rel="stylesheet" type="text/css" href="../stylesheet.css">
<link rel="start" href="../overview-summary.html">

<title>library\phirehose\lib\Phirehose.php (API Documentation: PHP Redis Fast)</title>

</head>
<body id="file" onload="parent.document.title=document.title;">

<div class="header">
<h1>PHP Redis Fast</h1>
<ul>
<li><a href="../overview-summary.html">Overview</a></li>
<li>Package</li><li>Class</li><li>Tree</li><li><a href="../overview-files.html">Files</a></li>
<li><a href="../deprecated-list.html">Deprecated</a></li>
<li><a href="../todo-list.html">Todo</a></li>
<li><a href="../index-all.html">Index</a></li>
</ul>
</div>

<div class="small_links">
<a href="../index.html" target="_top">Frames</a>
<a href="../source\library\phirehose\lib\phirehose.php.html" target="_top">No frames</a>
</div>
<hr>

<h1>library\phirehose\lib\Phirehose.php</h1>
<hr>

<a name="line1"></a><pre class="php" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">&lt;?php</span>
<a name="line2"></a><span style="color: #009933; font-style: italic;">/**
<a name="line3"></a> * A class that makes it easy to connect to and consume the Twitter stream via the Streaming API.
<a name="line4"></a> *
<a name="line5"></a> * Note: This is beta software - Please read the following carefully before using:
<a name="line6"></a> *  - http://code.google.com/p/phirehose/wiki/Introduction
<a name="line7"></a> *  - http://apiwiki.twitter.com/Streaming-API-Documentation
<a name="line8"></a> *
<a name="line9"></a> * @author  Fenn Bailey &lt;fenn.bailey@gmail.com&gt;
<a name="line10"></a> * @version 0.2.4 ($Id$)
<a name="line11"></a> */</span>
<a name="line12"></a>abstract <span style="color: #000000; font-weight: bold;">class</span> Phirehose
<a name="line13"></a><span style="color: #009900;">&#123;</span>
<a name="line14"></a>&nbsp;
<a name="line15"></a>  <span style="color: #009933; font-style: italic;">/**
<a name="line16"></a>   * Class constants
<a name="line17"></a>   */</span>
<a name="line18"></a>  <span style="color: #000000; font-weight: bold;">const</span> URL_BASE         <span style="color: #339933;">=</span> <span style="color: #0000ff;">'http://stream.twitter.com/1/statuses/'</span><span style="color: #339933;">;</span>
<a name="line19"></a>  <span style="color: #000000; font-weight: bold;">const</span> FORMAT_JSON      <span style="color: #339933;">=</span> <span style="color: #0000ff;">'json'</span><span style="color: #339933;">;</span>
<a name="line20"></a>  <span style="color: #000000; font-weight: bold;">const</span> FORMAT_XML       <span style="color: #339933;">=</span> <span style="color: #0000ff;">'xml'</span><span style="color: #339933;">;</span>
<a name="line21"></a>  <span style="color: #000000; font-weight: bold;">const</span> METHOD_FILTER    <span style="color: #339933;">=</span> <span style="color: #0000ff;">'filter'</span><span style="color: #339933;">;</span>
<a name="line22"></a>  <span style="color: #000000; font-weight: bold;">const</span> METHOD_SAMPLE    <span style="color: #339933;">=</span> <span style="color: #0000ff;">'sample'</span><span style="color: #339933;">;</span>
<a name="line23"></a>  <span style="color: #000000; font-weight: bold;">const</span> METHOD_RETWEET   <span style="color: #339933;">=</span> <span style="color: #0000ff;">'retweet'</span><span style="color: #339933;">;</span>
<a name="line24"></a>  <span style="color: #000000; font-weight: bold;">const</span> METHOD_FIREHOSE  <span style="color: #339933;">=</span> <span style="color: #0000ff;">'firehose'</span><span style="color: #339933;">;</span>
<a name="line25"></a>  <span style="color: #000000; font-weight: bold;">const</span> USER_AGENT       <span style="color: #339933;">=</span> <span style="color: #0000ff;">'Phirehose/0.2.4 +http://code.google.com/p/phirehose/'</span><span style="color: #339933;">;</span>
<a name="line26"></a>  <span style="color: #000000; font-weight: bold;">const</span> FILTER_CHECK_MIN <span style="color: #339933;">=</span> <span style="color: #cc66cc;">5</span><span style="color: #339933;">;</span>
<a name="line27"></a>  <span style="color: #000000; font-weight: bold;">const</span> FILTER_UPD_MIN   <span style="color: #339933;">=</span> <span style="color: #cc66cc;">120</span><span style="color: #339933;">;</span>
<a name="line28"></a>  <span style="color: #000000; font-weight: bold;">const</span> TCP_BACKOFF      <span style="color: #339933;">=</span> <span style="color: #cc66cc;">1</span><span style="color: #339933;">;</span>
<a name="line29"></a>  <span style="color: #000000; font-weight: bold;">const</span> TCP_BACKOFF_MAX  <span style="color: #339933;">=</span> <span style="color: #cc66cc;">16</span><span style="color: #339933;">;</span>
<a name="line30"></a>  <span style="color: #000000; font-weight: bold;">const</span> HTTP_BACKOFF     <span style="color: #339933;">=</span> <span style="color: #cc66cc;">10</span><span style="color: #339933;">;</span>
<a name="line31"></a>  <span style="color: #000000; font-weight: bold;">const</span> HTTP_BACKOFF_MAX <span style="color: #339933;">=</span> <span style="color: #cc66cc;">240</span><span style="color: #339933;">;</span>
<a name="line32"></a>  <span style="color: #000000; font-weight: bold;">const</span> EARTH_RADIUS_KM  <span style="color: #339933;">=</span> <span style="color: #cc66cc;">6371</span><span style="color: #339933;">;</span>
<a name="line33"></a>&nbsp;
<a name="line34"></a>&nbsp;
<a name="line35"></a>  <span style="color: #009933; font-style: italic;">/**
<a name="line36"></a>   * Member Attribs
<a name="line37"></a>   */</span>
<a name="line38"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$username</span><span style="color: #339933;">;</span>
<a name="line39"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$password</span><span style="color: #339933;">;</span>
<a name="line40"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$method</span><span style="color: #339933;">;</span>
<a name="line41"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$format</span><span style="color: #339933;">;</span>
<a name="line42"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$count</span><span style="color: #339933;">;</span>
<a name="line43"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$followIds</span><span style="color: #339933;">;</span>
<a name="line44"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$trackWords</span><span style="color: #339933;">;</span>
<a name="line45"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$locationBoxes</span><span style="color: #339933;">;</span>
<a name="line46"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$conn</span><span style="color: #339933;">;</span>
<a name="line47"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$fdrPool</span><span style="color: #339933;">;</span>
<a name="line48"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$buff</span><span style="color: #339933;">;</span>
<a name="line49"></a>  <span style="color: #666666; font-style: italic;">// State vars</span>
<a name="line50"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$filterChanged</span><span style="color: #339933;">;</span>
<a name="line51"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$reconnect</span><span style="color: #339933;">;</span>
<a name="line52"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$statusRate</span><span style="color: #339933;">;</span>
<a name="line53"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$lastErrorNo</span><span style="color: #339933;">;</span>
<a name="line54"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$lastErrorMsg</span><span style="color: #339933;">;</span>
<a name="line55"></a>  <span style="color: #666666; font-style: italic;">// Config type vars - override in subclass if desired</span>
<a name="line56"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$connectFailuresMax</span> <span style="color: #339933;">=</span> <span style="color: #cc66cc;">20</span><span style="color: #339933;">;</span>
<a name="line57"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$connectTimeout</span> <span style="color: #339933;">=</span> <span style="color: #cc66cc;">5</span><span style="color: #339933;">;</span>
<a name="line58"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$readTimeout</span> <span style="color: #339933;">=</span> <span style="color: #cc66cc;">5</span><span style="color: #339933;">;</span>
<a name="line59"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$idleReconnectTimeout</span> <span style="color: #339933;">=</span> <span style="color: #cc66cc;">90</span><span style="color: #339933;">;</span>
<a name="line60"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$avgPeriod</span> <span style="color: #339933;">=</span> <span style="color: #cc66cc;">60</span><span style="color: #339933;">;</span>
<a name="line61"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000088;">$status_length_base</span> <span style="color: #339933;">=</span> <span style="color: #cc66cc;">10</span><span style="color: #339933;">;</span>
<a name="line62"></a>&nbsp;
<a name="line63"></a>  <span style="color: #009933; font-style: italic;">/**
<a name="line64"></a>   * Create a new Phirehose object attached to the appropriate twitter stream method.
<a name="line65"></a>   * Methods are: METHOD_FIREHOSE, METHOD_RETWEET, METHOD_SAMPLE, METHOD_FILTER
<a name="line66"></a>   * Formats are: FORMAT_JSON, FORMAT_XML
<a name="line67"></a>   * @see Phirehose::METHOD_SAMPLE
<a name="line68"></a>   * @see Phirehose::FORMAT_JSON
<a name="line69"></a>   *
<a name="line70"></a>   * @param string $username Any twitter username
<a name="line71"></a>   * @param string $password Any twitter password
<a name="line72"></a>   * @param string $method
<a name="line73"></a>   * @param string $format
<a name="line74"></a>   */</span>
<a name="line75"></a>  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> __construct<span style="color: #009900;">&#40;</span><span style="color: #000088;">$username</span><span style="color: #339933;">,</span> <span style="color: #000088;">$password</span><span style="color: #339933;">,</span> <span style="color: #000088;">$method</span> <span style="color: #339933;">=</span> Phirehose<span style="color: #339933;">::</span><span style="color: #004000;">METHOD_SAMPLE</span><span style="color: #339933;">,</span> <span style="color: #000088;">$format</span> <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">FORMAT_JSON</span><span style="color: #009900;">&#41;</span>
<a name="line76"></a>  <span style="color: #009900;">&#123;</span>
<a name="line77"></a>    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">username</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$username</span><span style="color: #339933;">;</span>
<a name="line78"></a>    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">password</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$password</span><span style="color: #339933;">;</span>
<a name="line79"></a>    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">method</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$method</span><span style="color: #339933;">;</span>
<a name="line80"></a>    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">format</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$format</span><span style="color: #339933;">;</span>
<a name="line81"></a>  <span style="color: #009900;">&#125;</span>
<a name="line82"></a>&nbsp;
<a name="line83"></a>  <span style="color: #009933; font-style: italic;">/**
<a name="line84"></a>   * Returns public statuses from or in reply to a set of users. Mentions (&quot;Hello @user!&quot;) and implicit replies
<a name="line85"></a>   * (&quot;@user Hello!&quot; created without pressing the reply button) are not matched. It is up to you to find the integer
<a name="line86"></a>   * IDs of each twitter user.
<a name="line87"></a>   * Applies to: METHOD_FILTER
<a name="line88"></a>   *
<a name="line89"></a>   * @param array $userIds Array of Twitter integer userIDs
<a name="line90"></a>   */</span>
<a name="line91"></a>  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> setFollow<span style="color: #009900;">&#40;</span><span style="color: #000088;">$userIds</span><span style="color: #009900;">&#41;</span>
<a name="line92"></a>  <span style="color: #009900;">&#123;</span>
<a name="line93"></a>    <span style="color: #000088;">$userIds</span> <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$userIds</span> <span style="color: #339933;">===</span> <span style="color: #009900; font-weight: bold;">NULL</span><span style="color: #009900;">&#41;</span> ? <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">:</span> <span style="color: #000088;">$userIds</span><span style="color: #339933;">;</span>
<a name="line94"></a>    <a href="http://www.php.net/sort"><span style="color: #990000;">sort</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$userIds</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// Non-optimal but necessary</span>
<a name="line95"></a>    <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">followIds</span> <span style="color: #339933;">!=</span> <span style="color: #000088;">$userIds</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line96"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">filterChanged</span> <span style="color: #339933;">=</span> <span style="color: #009900; font-weight: bold;">TRUE</span><span style="color: #339933;">;</span>
<a name="line97"></a>    <span style="color: #009900;">&#125;</span>
<a name="line98"></a>    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">followIds</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$userIds</span><span style="color: #339933;">;</span>
<a name="line99"></a>  <span style="color: #009900;">&#125;</span>
<a name="line100"></a>&nbsp;
<a name="line101"></a>  <span style="color: #009933; font-style: italic;">/**
<a name="line102"></a>   * Returns an array of followed Twitter userIds (integers)
<a name="line103"></a>   *
<a name="line104"></a>   * @return array
<a name="line105"></a>   */</span>
<a name="line106"></a>  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> getFollow<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
<a name="line107"></a>  <span style="color: #009900;">&#123;</span>
<a name="line108"></a>    <span style="color: #b1b100;">return</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">followIds</span><span style="color: #339933;">;</span>
<a name="line109"></a>  <span style="color: #009900;">&#125;</span>
<a name="line110"></a>&nbsp;
<a name="line111"></a>  <span style="color: #009933; font-style: italic;">/**
<a name="line112"></a>   * Specifies keywords to track. Track keywords are case-insensitive logical ORs. Terms are exact-matched, ignoring
<a name="line113"></a>   * punctuation. Phrases, keywords with spaces, are not supported. Queries are subject to Track Limitations.
<a name="line114"></a>   * Applies to: METHOD_FILTER
<a name="line115"></a>   *
<a name="line116"></a>   * See: http://apiwiki.twitter.com/Streaming-API-Documentation#TrackLimiting
<a name="line117"></a>   *
<a name="line118"></a>   * @param array $trackWords
<a name="line119"></a>   */</span>
<a name="line120"></a>  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> setTrack<span style="color: #009900;">&#40;</span><span style="color: #000088;">$trackWords</span><span style="color: #009900;">&#41;</span>
<a name="line121"></a>  <span style="color: #009900;">&#123;</span>
<a name="line122"></a>    <span style="color: #000088;">$trackWords</span> <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$trackWords</span> <span style="color: #339933;">===</span> <span style="color: #009900; font-weight: bold;">NULL</span><span style="color: #009900;">&#41;</span> ? <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">:</span> <span style="color: #000088;">$trackWords</span><span style="color: #339933;">;</span>
<a name="line123"></a>    <a href="http://www.php.net/sort"><span style="color: #990000;">sort</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$trackWords</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// Non-optimal, but necessary</span>
<a name="line124"></a>    <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">trackWords</span> <span style="color: #339933;">!=</span> <span style="color: #000088;">$trackWords</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line125"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">filterChanged</span> <span style="color: #339933;">=</span> <span style="color: #009900; font-weight: bold;">TRUE</span><span style="color: #339933;">;</span>
<a name="line126"></a>    <span style="color: #009900;">&#125;</span>
<a name="line127"></a>    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">trackWords</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$trackWords</span><span style="color: #339933;">;</span>
<a name="line128"></a>  <span style="color: #009900;">&#125;</span>
<a name="line129"></a>&nbsp;
<a name="line130"></a>  <span style="color: #009933; font-style: italic;">/**
<a name="line131"></a>   * Returns an array of keywords being tracked
<a name="line132"></a>   *
<a name="line133"></a>   * @return array
<a name="line134"></a>   */</span>
<a name="line135"></a>  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> getTrack<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
<a name="line136"></a>  <span style="color: #009900;">&#123;</span>
<a name="line137"></a>    <span style="color: #b1b100;">return</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">trackWords</span><span style="color: #339933;">;</span>
<a name="line138"></a>  <span style="color: #009900;">&#125;</span>
<a name="line139"></a>&nbsp;
<a name="line140"></a>  <span style="color: #009933; font-style: italic;">/**
<a name="line141"></a>   * Specifies a set of bounding boxes to track as an array of 4 element lon/lat pairs denoting &lt;south-west point&gt;,
<a name="line142"></a>   * &lt;north-east point&gt;. Only tweets that are both created using the Geotagging API and are placed from within a tracked
<a name="line143"></a>   * bounding box will be included in the stream. The user's location field is not used to filter tweets. Bounding boxes
<a name="line144"></a>   * are logical ORs and must be less than or equal to 1 degree per side. A locations parameter may be combined with
<a name="line145"></a>   * track parameters, but note that all terms are logically ORd.
<a name="line146"></a>   *
<a name="line147"></a>   * NOTE: The argument order is Longitude/Latitude (to match the Twitter API and GeoJSON specifications).
<a name="line148"></a>   *
<a name="line149"></a>   * Applies to: METHOD_FILTER
<a name="line150"></a>   *
<a name="line151"></a>   * See: http://apiwiki.twitter.com/Streaming-API-Documentation#locations
<a name="line152"></a>   *
<a name="line153"></a>   * Eg:
<a name="line154"></a>   *  setLocations(array(
<a name="line155"></a>   *      array(-122.75, 36.8, -121.75, 37.8), // San Francisco
<a name="line156"></a>   *      array(-74, 40, -73, 41),             // New York
<a name="line157"></a>   *  ));
<a name="line158"></a>   *
<a name="line159"></a>   * @param array $boundingBoxes
<a name="line160"></a>   */</span>
<a name="line161"></a>  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> setLocations<span style="color: #009900;">&#40;</span><span style="color: #000088;">$boundingBoxes</span><span style="color: #009900;">&#41;</span>
<a name="line162"></a>  <span style="color: #009900;">&#123;</span>
<a name="line163"></a>    <span style="color: #000088;">$boundingBoxes</span> <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$boundingBoxes</span> <span style="color: #339933;">===</span> <span style="color: #009900; font-weight: bold;">NULL</span><span style="color: #009900;">&#41;</span> ? <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">:</span> <span style="color: #000088;">$boundingBoxes</span><span style="color: #339933;">;</span>
<a name="line164"></a>    <a href="http://www.php.net/sort"><span style="color: #990000;">sort</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$boundingBoxes</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// Non-optimal, but necessary</span>
<a name="line165"></a>    <span style="color: #666666; font-style: italic;">// Flatten to single dimensional array</span>
<a name="line166"></a>    <span style="color: #000088;">$locationBoxes</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line167"></a>    <span style="color: #b1b100;">foreach</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$boundingBoxes</span> <span style="color: #b1b100;">as</span> <span style="color: #000088;">$boundingBox</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line168"></a>      <span style="color: #666666; font-style: italic;">// Sanity check</span>
<a name="line169"></a>      <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><a href="http://www.php.net/count"><span style="color: #990000;">count</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$boundingBox</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">!=</span> <span style="color: #cc66cc;">4</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line170"></a>        <span style="color: #666666; font-style: italic;">// Invalid - Not much we can do here but log error</span>
<a name="line171"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Invalid location bounding box: ['</span> <span style="color: #339933;">.</span> <a href="http://www.php.net/implode"><span style="color: #990000;">implode</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">', '</span><span style="color: #339933;">,</span> <span style="color: #000088;">$boundingBox</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">']'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line172"></a>        <span style="color: #b1b100;">return</span> <span style="color: #009900; font-weight: bold;">FALSE</span><span style="color: #339933;">;</span>
<a name="line173"></a>      <span style="color: #009900;">&#125;</span>
<a name="line174"></a>      <span style="color: #666666; font-style: italic;">// Append this lat/lon pairs to flattened array</span>
<a name="line175"></a>      <span style="color: #000088;">$locationBoxes</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/array_merge"><span style="color: #990000;">array_merge</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$locationBoxes</span><span style="color: #339933;">,</span> <span style="color: #000088;">$boundingBox</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line176"></a>    <span style="color: #009900;">&#125;</span>
<a name="line177"></a>    <span style="color: #666666; font-style: italic;">// If it's changed, make note</span>
<a name="line178"></a>    <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">locationBoxes</span> <span style="color: #339933;">!=</span> <span style="color: #000088;">$locationBoxes</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line179"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">filterChanged</span> <span style="color: #339933;">=</span> <span style="color: #009900; font-weight: bold;">TRUE</span><span style="color: #339933;">;</span>
<a name="line180"></a>    <span style="color: #009900;">&#125;</span>
<a name="line181"></a>    <span style="color: #666666; font-style: italic;">// Set flattened value</span>
<a name="line182"></a>    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">locationBoxes</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$locationBoxes</span><span style="color: #339933;">;</span>
<a name="line183"></a>  <span style="color: #009900;">&#125;</span>
<a name="line184"></a>&nbsp;
<a name="line185"></a>  <span style="color: #009933; font-style: italic;">/**
<a name="line186"></a>   * Returns an array of 4 element arrays that denote the monitored location bounding boxes for tweets using the
<a name="line187"></a>   * Geotagging API.
<a name="line188"></a>   *
<a name="line189"></a>   * @see setLocations()
<a name="line190"></a>   * @return array
<a name="line191"></a>   */</span>
<a name="line192"></a>  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> getLocations<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line193"></a>    <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">locationBoxes</span> <span style="color: #339933;">==</span> <span style="color: #009900; font-weight: bold;">NULL</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line194"></a>      <span style="color: #b1b100;">return</span> <span style="color: #009900; font-weight: bold;">NULL</span><span style="color: #339933;">;</span>
<a name="line195"></a>    <span style="color: #009900;">&#125;</span>
<a name="line196"></a>    <span style="color: #000088;">$locationBoxes</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">locationBoxes</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// Copy array</span>
<a name="line197"></a>    <span style="color: #000088;">$ret</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line198"></a>    <span style="color: #b1b100;">while</span> <span style="color: #009900;">&#40;</span><a href="http://www.php.net/count"><span style="color: #990000;">count</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$locationBoxes</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">&gt;=</span> <span style="color: #cc66cc;">4</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line199"></a>      <span style="color: #000088;">$ret</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/array_splice"><span style="color: #990000;">array_splice</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$locationBoxes</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">4</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// Append to ret array in blocks of 4</span>
<a name="line200"></a>    <span style="color: #009900;">&#125;</span>
<a name="line201"></a>    <span style="color: #b1b100;">return</span> <span style="color: #000088;">$ret</span><span style="color: #339933;">;</span>
<a name="line202"></a>  <span style="color: #009900;">&#125;</span>
<a name="line203"></a>&nbsp;
<a name="line204"></a>  <span style="color: #009933; font-style: italic;">/**
<a name="line205"></a>   * Convenience method that sets location bounding boxes by an array of lon/lat/radius sets, rather than manually
<a name="line206"></a>   * specified bounding boxes. Each array element should contain 3 element subarray containing a latitude, longitude and
<a name="line207"></a>   * radius. Radius is specified in kilometers and is approximate (as boxes are square).
<a name="line208"></a>   *
<a name="line209"></a>   * NOTE: The argument order is Longitude/Latitude (to match the Twitter API and GeoJSON specifications).
<a name="line210"></a>   *
<a name="line211"></a>   * Eg:
<a name="line212"></a>   *  setLocationsByCircle(array(
<a name="line213"></a>   *      array(144.9631, -37.8142, 30), // Melbourne, 3km radius
<a name="line214"></a>   *      array(-0.1262, 51.5001, 25),   // London 10km radius
<a name="line215"></a>   *  ));
<a name="line216"></a>   *
<a name="line217"></a>   *
<a name="line218"></a>   * @see setLocations()
<a name="line219"></a>   * @param array
<a name="line220"></a>   */</span>
<a name="line221"></a>  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> setLocationsByCircle<span style="color: #009900;">&#40;</span><span style="color: #000088;">$locations</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line222"></a>    <span style="color: #000088;">$boundingBoxes</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line223"></a>    <span style="color: #b1b100;">foreach</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$locations</span> <span style="color: #b1b100;">as</span> <span style="color: #000088;">$locTriplet</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line224"></a>      <span style="color: #666666; font-style: italic;">// Sanity check</span>
<a name="line225"></a>      <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><a href="http://www.php.net/count"><span style="color: #990000;">count</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$locTriplet</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">!=</span> <span style="color: #cc66cc;">3</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line226"></a>        <span style="color: #666666; font-style: italic;">// Invalid - Not much we can do here but log error</span>
<a name="line227"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Invalid location triplet for '</span> <span style="color: #339933;">.</span> <span style="color: #009900; font-weight: bold;">__METHOD__</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">': ['</span> <span style="color: #339933;">.</span> <a href="http://www.php.net/implode"><span style="color: #990000;">implode</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">', '</span><span style="color: #339933;">,</span> <span style="color: #000088;">$locTriplet</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">']'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line228"></a>        <span style="color: #b1b100;">return</span> <span style="color: #009900; font-weight: bold;">FALSE</span><span style="color: #339933;">;</span>
<a name="line229"></a>      <span style="color: #009900;">&#125;</span>
<a name="line230"></a>      <a href="http://www.php.net/list"><span style="color: #990000;">list</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$lon</span><span style="color: #339933;">,</span> <span style="color: #000088;">$lat</span><span style="color: #339933;">,</span> <span style="color: #000088;">$radius</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$locTriplet</span><span style="color: #339933;">;</span>
<a name="line231"></a>&nbsp;
<a name="line232"></a>      <span style="color: #666666; font-style: italic;">// Calc bounding boxes</span>
<a name="line233"></a>      <span style="color: #000088;">$maxLat</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/round"><span style="color: #990000;">round</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$lat</span> <span style="color: #339933;">+</span> <a href="http://www.php.net/rad2deg"><span style="color: #990000;">rad2deg</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$radius</span> <span style="color: #339933;">/</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">EARTH_RADIUS_KM</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line234"></a>      <span style="color: #000088;">$minLat</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/round"><span style="color: #990000;">round</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$lat</span> <span style="color: #339933;">-</span> <a href="http://www.php.net/rad2deg"><span style="color: #990000;">rad2deg</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$radius</span> <span style="color: #339933;">/</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">EARTH_RADIUS_KM</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line235"></a>      <span style="color: #666666; font-style: italic;">// Compensate for degrees longitude getting smaller with increasing latitude</span>
<a name="line236"></a>      <span style="color: #000088;">$maxLon</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/round"><span style="color: #990000;">round</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$lon</span> <span style="color: #339933;">+</span> <a href="http://www.php.net/rad2deg"><span style="color: #990000;">rad2deg</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$radius</span> <span style="color: #339933;">/</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">EARTH_RADIUS_KM</span> <span style="color: #339933;">/</span> <a href="http://www.php.net/cos"><span style="color: #990000;">cos</span></a><span style="color: #009900;">&#40;</span><a href="http://www.php.net/deg2rad"><span style="color: #990000;">deg2rad</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$lat</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line237"></a>      <span style="color: #000088;">$minLon</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/round"><span style="color: #990000;">round</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$lon</span> <span style="color: #339933;">-</span> <a href="http://www.php.net/rad2deg"><span style="color: #990000;">rad2deg</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$radius</span> <span style="color: #339933;">/</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">EARTH_RADIUS_KM</span> <span style="color: #339933;">/</span> <a href="http://www.php.net/cos"><span style="color: #990000;">cos</span></a><span style="color: #009900;">&#40;</span><a href="http://www.php.net/deg2rad"><span style="color: #990000;">deg2rad</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$lat</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line238"></a>      <span style="color: #666666; font-style: italic;">// Add to bounding box array</span>
<a name="line239"></a>      <span style="color: #000088;">$boundingBoxes</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$minLon</span><span style="color: #339933;">,</span> <span style="color: #000088;">$minLat</span><span style="color: #339933;">,</span> <span style="color: #000088;">$maxLon</span><span style="color: #339933;">,</span> <span style="color: #000088;">$maxLat</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line240"></a>      <span style="color: #666666; font-style: italic;">// Debugging is handy</span>
<a name="line241"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Resolved location circle ['</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$lon</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">', '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$lat</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">', r: '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$radius</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">'] -&gt; bbox: ['</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$minLon</span> <span style="color: #339933;">.</span>
<a name="line242"></a>        <span style="color: #0000ff;">', '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$minLat</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">', '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$maxLon</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">', '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$maxLat</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">']'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line243"></a>    <span style="color: #009900;">&#125;</span>
<a name="line244"></a>    <span style="color: #666666; font-style: italic;">// Set by bounding boxes</span>
<a name="line245"></a>    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">setLocations</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$boundingBoxes</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line246"></a>  <span style="color: #009900;">&#125;</span>
<a name="line247"></a>&nbsp;
<a name="line248"></a>  <span style="color: #009933; font-style: italic;">/**
<a name="line249"></a>   * Sets the number of previous statuses to stream before transitioning to the live stream. Applies only to firehose
<a name="line250"></a>   * and filter + track methods. This is generally used internally and should not be needed by client applications.
<a name="line251"></a>   * Applies to: METHOD_FILTER, METHOD_FIREHOSE
<a name="line252"></a>   *
<a name="line253"></a>   * @param integer $count
<a name="line254"></a>   */</span>
<a name="line255"></a>  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> setCount<span style="color: #009900;">&#40;</span><span style="color: #000088;">$count</span><span style="color: #009900;">&#41;</span>
<a name="line256"></a>  <span style="color: #009900;">&#123;</span>
<a name="line257"></a>    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/count"><span style="color: #990000;">count</span></a> <span style="color: #339933;">=</span> <span style="color: #000088;">$count</span><span style="color: #339933;">;</span>
<a name="line258"></a>  <span style="color: #009900;">&#125;</span>
<a name="line259"></a>&nbsp;
<a name="line260"></a>  <span style="color: #009933; font-style: italic;">/**
<a name="line261"></a>   * Connects to the stream API and consumes the stream. Each status update in the stream will cause a call to the
<a name="line262"></a>   * handleStatus() method.
<a name="line263"></a>   *
<a name="line264"></a>   * @see handleStatus()
<a name="line265"></a>   * @param boolean $reconnect Reconnects as per recommended
<a name="line266"></a>   * @throws ErrorException
<a name="line267"></a>   */</span>
<a name="line268"></a>  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> consume<span style="color: #009900;">&#40;</span><span style="color: #000088;">$reconnect</span> <span style="color: #339933;">=</span> <span style="color: #009900; font-weight: bold;">TRUE</span><span style="color: #009900;">&#41;</span>
<a name="line269"></a>  <span style="color: #009900;">&#123;</span>
<a name="line270"></a>    <span style="color: #666666; font-style: italic;">// Persist connection?</span>
<a name="line271"></a>    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">reconnect</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$reconnect</span><span style="color: #339933;">;</span>
<a name="line272"></a>&nbsp;
<a name="line273"></a>    <span style="color: #666666; font-style: italic;">// Loop indefinitely based on reconnect</span>
<a name="line274"></a>    <span style="color: #b1b100;">do</span> <span style="color: #009900;">&#123;</span>
<a name="line275"></a>&nbsp;
<a name="line276"></a>      <span style="color: #666666; font-style: italic;">// (Re)connect</span>
<a name="line277"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">reconnect</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line278"></a>&nbsp;
<a name="line279"></a>      <span style="color: #666666; font-style: italic;">// Init state</span>
<a name="line280"></a>      <span style="color: #000088;">$statusCount</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$filterCheckCount</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$enqueueSpent</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$filterCheckSpent</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$idlePeriod</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$maxIdlePeriod</span> <span style="color: #339933;">=</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span>
<a name="line281"></a>      <span style="color: #000088;">$lastAverage</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$lastFilterCheck</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$lastFilterUpd</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$lastStreamActivity</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/time"><span style="color: #990000;">time</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line282"></a>      <span style="color: #000088;">$fdw</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$fde</span> <span style="color: #339933;">=</span> <span style="color: #009900; font-weight: bold;">NULL</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// Placeholder write/error file descriptors for stream_select</span>
<a name="line283"></a>&nbsp;
<a name="line284"></a>      <span style="color: #666666; font-style: italic;">// We use a blocking-select with timeout, to allow us to continue processing on idle streams</span>
<a name="line285"></a>      <span style="color: #b1b100;">while</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span> <span style="color: #339933;">!==</span> <span style="color: #009900; font-weight: bold;">NULL</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span><a href="http://www.php.net/feof"><span style="color: #990000;">feof</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$numChanged</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/stream_select"><span style="color: #990000;">stream_select</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">fdrPool</span><span style="color: #339933;">,</span> <span style="color: #000088;">$fdw</span><span style="color: #339933;">,</span> <span style="color: #000088;">$fde</span><span style="color: #339933;">,</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">readTimeout</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">!==</span> <span style="color: #009900; font-weight: bold;">FALSE</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line286"></a>        <span style="color: #666666; font-style: italic;">/* Unfortunately, we need to do a safety check for dead twitter streams - This seems to be able to happen where
<a name="line287"></a>         * you end up with a valid connection, but NO tweets coming along the wire (or keep alives). The below guards
<a name="line288"></a>         * against this.
<a name="line289"></a>         */</span>
<a name="line290"></a>        <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span><a href="http://www.php.net/time"><span style="color: #990000;">time</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">-</span> <span style="color: #000088;">$lastStreamActivity</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">&gt;</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">idleReconnectTimeout</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line291"></a>          <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Idle timeout: No stream activity for &gt; '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">idleReconnectTimeout</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">' seconds. '</span> <span style="color: #339933;">.</span>
<a name="line292"></a>           <span style="color: #0000ff;">' Reconnecting.'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line293"></a>          <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">reconnect</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line294"></a>          <span style="color: #000088;">$lastStreamActivity</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/time"><span style="color: #990000;">time</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line295"></a>          <span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span>
<a name="line296"></a>        <span style="color: #009900;">&#125;</span>
<a name="line297"></a>        <span style="color: #666666; font-style: italic;">// Process stream/buffer</span>
<a name="line298"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">fdrPool</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// Must reassign for stream_select()</span>
<a name="line299"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">buff</span> <span style="color: #339933;">.=</span> <a href="http://www.php.net/fread"><span style="color: #990000;">fread</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">6</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// Small non-blocking to get delimiter text</span>
<a name="line300"></a>        <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$eol</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/strpos"><span style="color: #990000;">strpos</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">buff</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">&quot;<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">===</span> <span style="color: #009900; font-weight: bold;">FALSE</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line301"></a>          <span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// We need a newline</span>
<a name="line302"></a>        <span style="color: #009900;">&#125;</span>
<a name="line303"></a>        <span style="color: #666666; font-style: italic;">// Track maximum idle period</span>
<a name="line304"></a>        <span style="color: #000088;">$idlePeriod</span> <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span><a href="http://www.php.net/time"><span style="color: #990000;">time</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">-</span> <span style="color: #000088;">$lastStreamActivity</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line305"></a>        <span style="color: #000088;">$maxIdlePeriod</span> <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$idlePeriod</span> <span style="color: #339933;">&gt;</span> <span style="color: #000088;">$maxIdlePeriod</span><span style="color: #009900;">&#41;</span> ? <span style="color: #000088;">$idlePeriod</span> <span style="color: #339933;">:</span> <span style="color: #000088;">$maxIdlePeriod</span><span style="color: #339933;">;</span>
<a name="line306"></a>        <span style="color: #666666; font-style: italic;">// We got a newline, this is stream activity</span>
<a name="line307"></a>        <span style="color: #000088;">$lastStreamActivity</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/time"><span style="color: #990000;">time</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line308"></a>        <span style="color: #666666; font-style: italic;">// Read status length delimiter</span>
<a name="line309"></a>        <span style="color: #000088;">$delimiter</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/substr"><span style="color: #990000;">substr</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">buff</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span> <span style="color: #000088;">$eol</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line310"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">buff</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/substr"><span style="color: #990000;">substr</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">buff</span><span style="color: #339933;">,</span> <span style="color: #000088;">$eol</span> <span style="color: #339933;">+</span> <span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// consume off buffer, + 2 = &quot;\r\n&quot;</span>
<a name="line311"></a>        <span style="color: #000088;">$statusLength</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/intval"><span style="color: #990000;">intval</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$delimiter</span><span style="color: #339933;">,</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">status_length_base</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line312"></a>        <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$statusLength</span> <span style="color: #339933;">&gt;</span> <span style="color: #cc66cc;">0</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line313"></a>          <span style="color: #666666; font-style: italic;">// Read status bytes and enqueue</span>
<a name="line314"></a>          <span style="color: #000088;">$bytesLeft</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$statusLength</span> <span style="color: #339933;">-</span> <a href="http://www.php.net/strlen"><span style="color: #990000;">strlen</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">buff</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line315"></a>          <span style="color: #b1b100;">while</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$bytesLeft</span> <span style="color: #339933;">&gt;</span> <span style="color: #cc66cc;">0</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span> <span style="color: #339933;">!==</span> <span style="color: #009900; font-weight: bold;">NULL</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span><a href="http://www.php.net/feof"><span style="color: #990000;">feof</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$numChanged</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/stream_select"><span style="color: #990000;">stream_select</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">fdrPool</span><span style="color: #339933;">,</span> <span style="color: #000088;">$fdw</span><span style="color: #339933;">,</span> <span style="color: #000088;">$fde</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">20000</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">!==</span> <span style="color: #009900; font-weight: bold;">FALSE</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line316"></a>            <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">fdrPool</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// Reassign</span>
<a name="line317"></a>            <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">buff</span> <span style="color: #339933;">.=</span> <a href="http://www.php.net/fread"><span style="color: #990000;">fread</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #339933;">,</span> <span style="color: #000088;">$bytesLeft</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// Read until all bytes are read into buffer</span>
<a name="line318"></a>            <span style="color: #000088;">$bytesLeft</span> <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$statusLength</span> <span style="color: #339933;">-</span> <a href="http://www.php.net/strlen"><span style="color: #990000;">strlen</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">buff</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line319"></a>          <span style="color: #009900;">&#125;</span>
<a name="line320"></a>          <span style="color: #666666; font-style: italic;">// Accrue/enqueue and track time spent enqueing</span>
<a name="line321"></a>          <span style="color: #000088;">$enqueueStart</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/microtime"><span style="color: #990000;">microtime</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900; font-weight: bold;">TRUE</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line322"></a>          <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">enqueueStatus</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">buff</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line323"></a>          	<span style="color: #000088;">$statusCount</span><span style="color: #339933;">++;</span>
<a name="line324"></a>          	<span style="color: #000088;">$enqueueSpent</span> <span style="color: #339933;">+=</span> <span style="color: #009900;">&#40;</span><a href="http://www.php.net/microtime"><span style="color: #990000;">microtime</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900; font-weight: bold;">TRUE</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">-</span> <span style="color: #000088;">$enqueueStart</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line325"></a>          <span style="color: #009900;">&#125;</span>
<a name="line326"></a>        <span style="color: #009900;">&#125;</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">&#123;</span>
<a name="line327"></a>          <span style="color: #666666; font-style: italic;">// Timeout/no data after readTimeout seconds</span>
<a name="line328"></a>&nbsp;
<a name="line329"></a>        <span style="color: #009900;">&#125;</span>
<a name="line330"></a>        <span style="color: #666666; font-style: italic;">// Calc counter averages</span>
<a name="line331"></a>        <span style="color: #000088;">$avgElapsed</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/time"><span style="color: #990000;">time</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">-</span> <span style="color: #000088;">$lastAverage</span><span style="color: #339933;">;</span>
<a name="line332"></a>        <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$avgElapsed</span> <span style="color: #339933;">&gt;=</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">avgPeriod</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line333"></a>          <span style="color: #666666; font-style: italic;">// Calc tweets-per-second</span>
<a name="line334"></a>          <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">statusRate</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/round"><span style="color: #990000;">round</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$statusCount</span> <span style="color: #339933;">/</span> <span style="color: #000088;">$avgElapsed</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">0</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line335"></a>          <span style="color: #666666; font-style: italic;">// Calc time spent per enqueue in ms</span>
<a name="line336"></a>          <span style="color: #000088;">$enqueueTimeMS</span> <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$statusCount</span> <span style="color: #339933;">&gt;</span> <span style="color: #cc66cc;">0</span><span style="color: #009900;">&#41;</span> ? <a href="http://www.php.net/round"><span style="color: #990000;">round</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$enqueueSpent</span> <span style="color: #339933;">/</span> <span style="color: #000088;">$statusCount</span> <span style="color: #339933;">*</span> <span style="color: #cc66cc;">1000</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">:</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span>
<a name="line337"></a>          <span style="color: #666666; font-style: italic;">// Calc time spent total in filter predicate checking</span>
<a name="line338"></a>          <span style="color: #000088;">$filterCheckTimeMS</span> <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$filterCheckCount</span> <span style="color: #339933;">&gt;</span> <span style="color: #cc66cc;">0</span><span style="color: #009900;">&#41;</span> ? <a href="http://www.php.net/round"><span style="color: #990000;">round</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$filterCheckSpent</span> <span style="color: #339933;">/</span> <span style="color: #000088;">$filterCheckCount</span> <span style="color: #339933;">*</span> <span style="color: #cc66cc;">1000</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">:</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span>
<a name="line339"></a>          <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Consume rate: '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">statusRate</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">' status/sec ('</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$statusCount</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">' total), avg '</span> <span style="color: #339933;">.</span>
<a name="line340"></a>            <span style="color: #0000ff;">'enqueueStatus(): '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$enqueueTimeMS</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">'ms, avg checkFilterPredicates(): '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$filterCheckTimeMS</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">'ms ('</span> <span style="color: #339933;">.</span>
<a name="line341"></a>            <span style="color: #000088;">$filterCheckCount</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">' total) over '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">avgPeriod</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">' seconds, max stream idle period: '</span> <span style="color: #339933;">.</span>
<a name="line342"></a>              <span style="color: #000088;">$maxIdlePeriod</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">' seconds.'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line343"></a>          <span style="color: #000088;">$elapsed</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$avgElapsed</span><span style="color: #339933;">;</span>
<a name="line344"></a>          <span style="color: #000088;">$statusRate</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">statusRate</span><span style="color: #339933;">;</span>
<a name="line345"></a>          <span style="color: #000088;">$enqueueSpentAvg</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$enqueueTimeMS</span><span style="color: #339933;">;</span>
<a name="line346"></a>          <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">heartbeat</span><span style="color: #009900;">&#40;</span><a href="http://www.php.net/compact"><span style="color: #990000;">compact</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'elapsed'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'statusRate'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'statusCount'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'enqueueSpent'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'enqueueSpentAvg'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'filterCheckCount'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'filterCheckSpent'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'idlePeriod'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'maxIdlePeriod'</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line347"></a>          <span style="color: #666666; font-style: italic;">// Reset</span>
<a name="line348"></a>          <span style="color: #000088;">$elapsed</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$statusRate</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$statusCount</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$filterCheckCount</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$enqueueSpent</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$enqueueSpentAvg</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$filterCheckSpent</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$idlePeriod</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$maxIdlePeriod</span> <span style="color: #339933;">=</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span>
<a name="line349"></a>          <span style="color: #000088;">$lastAverage</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/time"><span style="color: #990000;">time</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line350"></a>        <span style="color: #009900;">&#125;</span>
<a name="line351"></a>        <span style="color: #666666; font-style: italic;">// Check if we're ready to check filter predicates</span>
<a name="line352"></a>        <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">method</span> <span style="color: #339933;">==</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">METHOD_FILTER</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">&#40;</span><a href="http://www.php.net/time"><span style="color: #990000;">time</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">-</span> <span style="color: #000088;">$lastFilterCheck</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">&gt;=</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">FILTER_CHECK_MIN</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line353"></a>          <span style="color: #000088;">$filterCheckCount</span> <span style="color: #339933;">++;</span>
<a name="line354"></a>          <span style="color: #000088;">$lastFilterCheck</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/time"><span style="color: #990000;">time</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line355"></a>          <span style="color: #000088;">$filterCheckStart</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/microtime"><span style="color: #990000;">microtime</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900; font-weight: bold;">TRUE</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line356"></a>          <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">checkFilterPredicates</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// This should be implemented in subclass if required</span>
<a name="line357"></a>          <span style="color: #000088;">$filterCheckSpent</span> <span style="color: #339933;">+=</span>  <span style="color: #009900;">&#40;</span><a href="http://www.php.net/microtime"><span style="color: #990000;">microtime</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900; font-weight: bold;">TRUE</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">-</span> <span style="color: #000088;">$filterCheckStart</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line358"></a>        <span style="color: #009900;">&#125;</span>
<a name="line359"></a>        <span style="color: #666666; font-style: italic;">// Check if filter is ready + allowed to be updated (reconnect)</span>
<a name="line360"></a>        <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">filterChanged</span> <span style="color: #339933;">==</span> <span style="color: #009900; font-weight: bold;">TRUE</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">&#40;</span><a href="http://www.php.net/time"><span style="color: #990000;">time</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">-</span> <span style="color: #000088;">$lastFilterUpd</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">&gt;=</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">FILTER_UPD_MIN</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line361"></a>          <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Reconnecting due to changed filter predicates.'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line362"></a>          <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">reconnect</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line363"></a>          <span style="color: #000088;">$lastFilterUpd</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/time"><span style="color: #990000;">time</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line364"></a>        <span style="color: #009900;">&#125;</span>
<a name="line365"></a>&nbsp;
<a name="line366"></a>      <span style="color: #009900;">&#125;</span> <span style="color: #666666; font-style: italic;">// End while-stream-activity</span>
<a name="line367"></a>&nbsp;
<a name="line368"></a>      <span style="color: #666666; font-style: italic;">// Some sort of socket error has occured</span>
<a name="line369"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">lastErrorNo</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/is_resource"><span style="color: #990000;">is_resource</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #009900;">&#41;</span> ? <span style="color: #339933;">@</span><a href="http://www.php.net/socket_last_error"><span style="color: #990000;">socket_last_error</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">:</span> <span style="color: #009900; font-weight: bold;">NULL</span><span style="color: #339933;">;</span>
<a name="line370"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">lastErrorMsg</span> <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">lastErrorNo</span> <span style="color: #339933;">&gt;</span> <span style="color: #cc66cc;">0</span><span style="color: #009900;">&#41;</span> ? <span style="color: #339933;">@</span><a href="http://www.php.net/socket_strerror"><span style="color: #990000;">socket_strerror</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">lastErrorNo</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">:</span> <span style="color: #0000ff;">'Socket disconnected'</span><span style="color: #339933;">;</span>
<a name="line371"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Phirehose connection error occured: '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">lastErrorMsg</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line372"></a>&nbsp;
<a name="line373"></a>      <span style="color: #666666; font-style: italic;">// Reconnect</span>
<a name="line374"></a>    <span style="color: #009900;">&#125;</span> <span style="color: #b1b100;">while</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">reconnect</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line375"></a>&nbsp;
<a name="line376"></a>    <span style="color: #666666; font-style: italic;">// Exit</span>
<a name="line377"></a>    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Exiting.'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line378"></a>&nbsp;
<a name="line379"></a>  <span style="color: #009900;">&#125;</span>
<a name="line380"></a>&nbsp;
<a name="line381"></a>  <span style="color: #009933; font-style: italic;">/**
<a name="line382"></a>   * Returns the last error message (TCP or HTTP) that occured with the streaming API or client. State is cleared upon
<a name="line383"></a>   * successful reconnect
<a name="line384"></a>   * @return string
<a name="line385"></a>   */</span>
<a name="line386"></a>  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> getLastErrorMsg<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
<a name="line387"></a>  <span style="color: #009900;">&#123;</span>
<a name="line388"></a>    <span style="color: #b1b100;">return</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">lastErrorMsg</span><span style="color: #339933;">;</span>
<a name="line389"></a>  <span style="color: #009900;">&#125;</span>
<a name="line390"></a>&nbsp;
<a name="line391"></a>  <span style="color: #009933; font-style: italic;">/**
<a name="line392"></a>   * Returns the last error number that occured with the streaming API or client. Numbers correspond to either the
<a name="line393"></a>   * fsockopen() error states (in the case of TCP errors) or HTTP error codes from Twitter (in the case of HTTP errors).
<a name="line394"></a>   *
<a name="line395"></a>   * State is cleared upon successful reconnect.
<a name="line396"></a>   *
<a name="line397"></a>   * @return string
<a name="line398"></a>   */</span>
<a name="line399"></a>  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> getLastErrorNo<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
<a name="line400"></a>  <span style="color: #009900;">&#123;</span>
<a name="line401"></a>    <span style="color: #b1b100;">return</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">lastErrorNo</span><span style="color: #339933;">;</span>
<a name="line402"></a>  <span style="color: #009900;">&#125;</span>
<a name="line403"></a>&nbsp;
<a name="line404"></a>&nbsp;
<a name="line405"></a>  <span style="color: #009933; font-style: italic;">/**
<a name="line406"></a>   * Connects to the stream URL using the configured method.
<a name="line407"></a>   * @throws ErrorException
<a name="line408"></a>   */</span>
<a name="line409"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000000; font-weight: bold;">function</span> connect<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
<a name="line410"></a>  <span style="color: #009900;">&#123;</span>
<a name="line411"></a>&nbsp;
<a name="line412"></a>    <span style="color: #666666; font-style: italic;">// Init state</span>
<a name="line413"></a>    <span style="color: #000088;">$connectFailures</span> <span style="color: #339933;">=</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span>
<a name="line414"></a>    <span style="color: #000088;">$tcpRetry</span> <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">TCP_BACKOFF</span> <span style="color: #339933;">/</span> <span style="color: #cc66cc;">2</span><span style="color: #339933;">;</span>
<a name="line415"></a>    <span style="color: #000088;">$httpRetry</span> <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">HTTP_BACKOFF</span> <span style="color: #339933;">/</span> <span style="color: #cc66cc;">2</span><span style="color: #339933;">;</span>
<a name="line416"></a>&nbsp;
<a name="line417"></a>    <span style="color: #666666; font-style: italic;">// Keep trying until connected (or max connect failures exceeded)</span>
<a name="line418"></a>    <span style="color: #b1b100;">do</span> <span style="color: #009900;">&#123;</span>
<a name="line419"></a>&nbsp;
<a name="line420"></a>      <span style="color: #666666; font-style: italic;">// Check filter predicates for every connect (for filter method)</span>
<a name="line421"></a>      <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">method</span> <span style="color: #339933;">==</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">METHOD_FILTER</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line422"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">checkFilterPredicates</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line423"></a>      <span style="color: #009900;">&#125;</span>
<a name="line424"></a>&nbsp;
<a name="line425"></a>      <span style="color: #666666; font-style: italic;">// Construct URL/HTTP bits</span>
<a name="line426"></a>      <span style="color: #000088;">$url</span> <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">URL_BASE</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">method</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">'.'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">format</span><span style="color: #339933;">;</span>
<a name="line427"></a>      <span style="color: #000088;">$urlParts</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/parse_url"><span style="color: #990000;">parse_url</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$url</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line428"></a>&nbsp;
<a name="line429"></a>      <span style="color: #666666; font-style: italic;">// Setup params appropriately</span>
<a name="line430"></a>      <span style="color: #000088;">$requestParams</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'delimited'</span> <span style="color: #339933;">=&gt;</span> <span style="color: #0000ff;">'length'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line431"></a>&nbsp;
<a name="line432"></a>      <span style="color: #666666; font-style: italic;">// Filter takes additional parameters</span>
<a name="line433"></a>      <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">method</span> <span style="color: #339933;">==</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">METHOD_FILTER</span> <span style="color: #339933;">&amp;&amp;</span> <a href="http://www.php.net/count"><span style="color: #990000;">count</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">trackWords</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">&gt;</span> <span style="color: #cc66cc;">0</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line434"></a>        <span style="color: #000088;">$requestParams</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'track'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/implode"><span style="color: #990000;">implode</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">','</span><span style="color: #339933;">,</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">trackWords</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line435"></a>      <span style="color: #009900;">&#125;</span>
<a name="line436"></a>      <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">method</span> <span style="color: #339933;">==</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">METHOD_FILTER</span> <span style="color: #339933;">&amp;&amp;</span> <a href="http://www.php.net/count"><span style="color: #990000;">count</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">followIds</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">&gt;</span> <span style="color: #cc66cc;">0</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line437"></a>        <span style="color: #000088;">$requestParams</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'follow'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/implode"><span style="color: #990000;">implode</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">','</span><span style="color: #339933;">,</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">followIds</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line438"></a>      <span style="color: #009900;">&#125;</span>
<a name="line439"></a>      <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">method</span> <span style="color: #339933;">==</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">METHOD_FILTER</span> <span style="color: #339933;">&amp;&amp;</span> <a href="http://www.php.net/count"><span style="color: #990000;">count</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">locationBoxes</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">&gt;</span> <span style="color: #cc66cc;">0</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line440"></a>        <span style="color: #000088;">$requestParams</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'locations'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/implode"><span style="color: #990000;">implode</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">','</span><span style="color: #339933;">,</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">locationBoxes</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line441"></a>      <span style="color: #009900;">&#125;</span>
<a name="line442"></a>      <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/count"><span style="color: #990000;">count</span></a> <span style="color: #339933;">&lt;&gt;</span> <span style="color: #cc66cc;">0</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line443"></a>        <span style="color: #000088;">$requestParams</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'count'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/count"><span style="color: #990000;">count</span></a><span style="color: #339933;">;</span>
<a name="line444"></a>      <span style="color: #009900;">&#125;</span>
<a name="line445"></a>&nbsp;
<a name="line446"></a>      <span style="color: #666666; font-style: italic;">// Debugging is useful</span>
<a name="line447"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Connecting to twitter stream: '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$url</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">' with params: '</span> <span style="color: #339933;">.</span> <a href="http://www.php.net/str_replace"><span style="color: #990000;">str_replace</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">''</span><span style="color: #339933;">,</span>
<a name="line448"></a>        <a href="http://www.php.net/var_export"><span style="color: #990000;">var_export</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$requestParams</span><span style="color: #339933;">,</span> <span style="color: #009900; font-weight: bold;">TRUE</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line449"></a>&nbsp;
<a name="line450"></a>      <span style="color: #009933; font-style: italic;">/**
<a name="line451"></a>       * Open socket connection to make POST request. It'd be nice to use stream_context_create with the native
<a name="line452"></a>       * HTTP transport but it hides/abstracts too many required bits (like HTTP error responses).
<a name="line453"></a>       */</span>
<a name="line454"></a>      <span style="color: #000088;">$errNo</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$errStr</span> <span style="color: #339933;">=</span> <span style="color: #009900; font-weight: bold;">NULL</span><span style="color: #339933;">;</span>
<a name="line455"></a>      <span style="color: #000088;">$scheme</span> <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$urlParts</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'scheme'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">==</span> <span style="color: #0000ff;">'https'</span><span style="color: #009900;">&#41;</span> ? <span style="color: #0000ff;">'ssl://'</span> <span style="color: #339933;">:</span> <span style="color: #0000ff;">'tcp://'</span><span style="color: #339933;">;</span>
<a name="line456"></a>      <span style="color: #000088;">$port</span> <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$urlParts</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'scheme'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">==</span> <span style="color: #0000ff;">'https'</span><span style="color: #009900;">&#41;</span> ? <span style="color: #cc66cc;">443</span> <span style="color: #339933;">:</span> <span style="color: #cc66cc;">80</span><span style="color: #339933;">;</span>
<a name="line457"></a>&nbsp;
<a name="line458"></a>      <span style="color: #009933; font-style: italic;">/**
<a name="line459"></a>       * We must perform manual host resolution here as Twitter's IP regularly rotates (ie: DNS TTL of 60 seconds) and
<a name="line460"></a>       * PHP appears to cache it the result if in a long running process (as per Phirehose).
<a name="line461"></a>       */</span>
<a name="line462"></a>      <span style="color: #000088;">$streamIPs</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/gethostbynamel"><span style="color: #990000;">gethostbynamel</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$urlParts</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'host'</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line463"></a>      <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><a href="http://www.php.net/empty"><span style="color: #990000;">empty</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$streamIPs</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line464"></a>        <span style="color: #b1b100;">throw</span> <span style="color: #000000; font-weight: bold;">new</span> PhirehoseNetworkException<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Unable to resolve hostname: '&quot;</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$urlParts</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'host'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">'&quot;'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line465"></a>      <span style="color: #009900;">&#125;</span>
<a name="line466"></a>&nbsp;
<a name="line467"></a>      <span style="color: #666666; font-style: italic;">// Choose one randomly (if more than one)</span>
<a name="line468"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Resolved host '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$urlParts</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'host'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">' to '</span> <span style="color: #339933;">.</span> <a href="http://www.php.net/implode"><span style="color: #990000;">implode</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">', '</span><span style="color: #339933;">,</span> <span style="color: #000088;">$streamIPs</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line469"></a>      <span style="color: #000088;">$streamIP</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$streamIPs</span><span style="color: #009900;">&#91;</span><a href="http://www.php.net/rand"><span style="color: #990000;">rand</span></a><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span> <span style="color: #009900;">&#40;</span><a href="http://www.php.net/count"><span style="color: #990000;">count</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$streamIPs</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">-</span> <span style="color: #cc66cc;">1</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
<a name="line470"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Connecting to '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$streamIP</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line471"></a>&nbsp;
<a name="line472"></a>      <span style="color: #339933;">@</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/fsockopen"><span style="color: #990000;">fsockopen</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$scheme</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$streamIP</span><span style="color: #339933;">,</span> <span style="color: #000088;">$port</span><span style="color: #339933;">,</span> <span style="color: #000088;">$errNo</span><span style="color: #339933;">,</span> <span style="color: #000088;">$errStr</span><span style="color: #339933;">,</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">connectTimeout</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line473"></a>&nbsp;
<a name="line474"></a>      <span style="color: #666666; font-style: italic;">// No go - handle errors/backoff</span>
<a name="line475"></a>      <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #339933;">!</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span> <span style="color: #339933;">||</span> <span style="color: #339933;">!</span><a href="http://www.php.net/is_resource"><span style="color: #990000;">is_resource</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line476"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">lastErrorMsg</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$errStr</span><span style="color: #339933;">;</span>
<a name="line477"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">lastErrorNo</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$errNo</span><span style="color: #339933;">;</span>
<a name="line478"></a>        <span style="color: #000088;">$connectFailures</span> <span style="color: #339933;">++;</span>
<a name="line479"></a>        <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$connectFailures</span> <span style="color: #339933;">&gt;</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">connectFailuresMax</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line480"></a>          <span style="color: #000088;">$msg</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">'TCP failure limit exceeded with '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$connectFailures</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">' failures. Last error: '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$errStr</span><span style="color: #339933;">;</span>
<a name="line481"></a>          <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$msg</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line482"></a>          <span style="color: #b1b100;">throw</span> <span style="color: #000000; font-weight: bold;">new</span> PhirehoseConnectLimitExceeded<span style="color: #009900;">&#40;</span><span style="color: #000088;">$msg</span><span style="color: #339933;">,</span> <span style="color: #000088;">$errNo</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// Throw an exception for other code to handle</span>
<a name="line483"></a>        <span style="color: #009900;">&#125;</span>
<a name="line484"></a>        <span style="color: #666666; font-style: italic;">// Increase retry/backoff up to max</span>
<a name="line485"></a>        <span style="color: #000088;">$tcpRetry</span> <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$tcpRetry</span> <span style="color: #339933;">&lt;</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">TCP_BACKOFF_MAX</span><span style="color: #009900;">&#41;</span> ? <span style="color: #000088;">$tcpRetry</span> <span style="color: #339933;">*</span> <span style="color: #cc66cc;">2</span> <span style="color: #339933;">:</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">TCP_BACKOFF_MAX</span><span style="color: #339933;">;</span>
<a name="line486"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'TCP failure '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$connectFailures</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">' of '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">connectFailuresMax</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">' connecting to stream: '</span> <span style="color: #339933;">.</span>
<a name="line487"></a>          <span style="color: #000088;">$errStr</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">' ('</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$errNo</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">'). Sleeping for '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$tcpRetry</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">' seconds.'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line488"></a>        <a href="http://www.php.net/sleep"><span style="color: #990000;">sleep</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$tcpRetry</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line489"></a>        <span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span>
<a name="line490"></a>      <span style="color: #009900;">&#125;</span>
<a name="line491"></a>&nbsp;
<a name="line492"></a>      <span style="color: #666666; font-style: italic;">// TCP connect OK, clear last error (if present)</span>
<a name="line493"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Connection established to '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$streamIP</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line494"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">lastErrorMsg</span> <span style="color: #339933;">=</span> <span style="color: #009900; font-weight: bold;">NULL</span><span style="color: #339933;">;</span>
<a name="line495"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">lastErrorNo</span> <span style="color: #339933;">=</span> <span style="color: #009900; font-weight: bold;">NULL</span><span style="color: #339933;">;</span>
<a name="line496"></a>&nbsp;
<a name="line497"></a>      <span style="color: #666666; font-style: italic;">// If we have a socket connection, we can attempt a HTTP request - Ensure blocking read for the moment</span>
<a name="line498"></a>      <a href="http://www.php.net/stream_set_blocking"><span style="color: #990000;">stream_set_blocking</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">1</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line499"></a>&nbsp;
<a name="line500"></a>      <span style="color: #666666; font-style: italic;">// Encode request data</span>
<a name="line501"></a>      <span style="color: #000088;">$postData</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/http_build_query"><span style="color: #990000;">http_build_query</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$requestParams</span><span style="color: #339933;">,</span> <span style="color: #009900; font-weight: bold;">NULL</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'&amp;'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line502"></a>      <span style="color: #000088;">$authCredentials</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">getAuthorizationHeader</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line503"></a>&nbsp;
<a name="line504"></a>      <span style="color: #666666; font-style: italic;">// Do it</span>
<a name="line505"></a>      <a href="http://www.php.net/fwrite"><span style="color: #990000;">fwrite</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">&quot;POST &quot;</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$urlParts</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'path'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">&quot; HTTP/1.0<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line506"></a>      <a href="http://www.php.net/fwrite"><span style="color: #990000;">fwrite</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">&quot;Host: &quot;</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$urlParts</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'host'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">':'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$port</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">&quot;<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line507"></a>      <a href="http://www.php.net/fwrite"><span style="color: #990000;">fwrite</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">&quot;Content-type: application/x-www-form-urlencoded<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line508"></a>      <a href="http://www.php.net/fwrite"><span style="color: #990000;">fwrite</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">&quot;Content-length: &quot;</span> <span style="color: #339933;">.</span> <a href="http://www.php.net/strlen"><span style="color: #990000;">strlen</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$postData</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">&quot;<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line509"></a>      <a href="http://www.php.net/fwrite"><span style="color: #990000;">fwrite</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">&quot;Accept: */*<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line510"></a>      <a href="http://www.php.net/fwrite"><span style="color: #990000;">fwrite</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'Authorization: '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$authCredentials</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">&quot;<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line511"></a>      <a href="http://www.php.net/fwrite"><span style="color: #990000;">fwrite</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'User-Agent: '</span> <span style="color: #339933;">.</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">USER_AGENT</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">&quot;<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line512"></a>      <a href="http://www.php.net/fwrite"><span style="color: #990000;">fwrite</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">&quot;<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line513"></a>      <a href="http://www.php.net/fwrite"><span style="color: #990000;">fwrite</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #339933;">,</span> <span style="color: #000088;">$postData</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">&quot;<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line514"></a>      <a href="http://www.php.net/fwrite"><span style="color: #990000;">fwrite</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">&quot;<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line515"></a>&nbsp;
<a name="line516"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;POST &quot;</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$urlParts</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'path'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">&quot; HTTP/1.0<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line517"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Host: &quot;</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$urlParts</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'host'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">':'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$port</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">&quot;<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line518"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Content-type: application/x-www-form-urlencoded<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line519"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Content-length: &quot;</span> <span style="color: #339933;">.</span> <a href="http://www.php.net/strlen"><span style="color: #990000;">strlen</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$postData</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">&quot;<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line520"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Accept: */*<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line521"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Authorization: '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$authCredentials</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">&quot;<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line522"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'User-Agent: '</span> <span style="color: #339933;">.</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">USER_AGENT</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">&quot;<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line523"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line524"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$postData</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">&quot;<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line525"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;<span style="color: #000099; font-weight: bold;">\r</span><span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line526"></a>&nbsp;
<a name="line527"></a>      <span style="color: #666666; font-style: italic;">// First line is response</span>
<a name="line528"></a>      <a href="http://www.php.net/list"><span style="color: #990000;">list</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$httpVer</span><span style="color: #339933;">,</span> <span style="color: #000088;">$httpCode</span><span style="color: #339933;">,</span> <span style="color: #000088;">$httpMessage</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/preg_split"><span style="color: #990000;">preg_split</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'/\s+/'</span><span style="color: #339933;">,</span> <a href="http://www.php.net/trim"><span style="color: #990000;">trim</span></a><span style="color: #009900;">&#40;</span><a href="http://www.php.net/fgets"><span style="color: #990000;">fgets</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">1024</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">3</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line529"></a>&nbsp;
<a name="line530"></a>      <span style="color: #666666; font-style: italic;">// Response buffers</span>
<a name="line531"></a>      <span style="color: #000088;">$respHeaders</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$respBody</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">''</span><span style="color: #339933;">;</span>
<a name="line532"></a>&nbsp;
<a name="line533"></a>      <span style="color: #666666; font-style: italic;">// Consume each header response line until we get to body</span>
<a name="line534"></a>      <span style="color: #b1b100;">while</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$hLine</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/trim"><span style="color: #990000;">trim</span></a><span style="color: #009900;">&#40;</span><a href="http://www.php.net/fgets"><span style="color: #990000;">fgets</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">4096</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line535"></a>        <span style="color: #000088;">$respHeaders</span> <span style="color: #339933;">.=</span> <span style="color: #000088;">$hLine</span><span style="color: #339933;">;</span>
<a name="line536"></a>      <span style="color: #009900;">&#125;</span>
<a name="line537"></a>&nbsp;
<a name="line538"></a>      <span style="color: #666666; font-style: italic;">// If we got a non-200 response, we need to backoff and retry</span>
<a name="line539"></a>      <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$httpCode</span> <span style="color: #339933;">!=</span> <span style="color: #cc66cc;">200</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line540"></a>        <span style="color: #000088;">$connectFailures</span> <span style="color: #339933;">++;</span>
<a name="line541"></a>&nbsp;
<a name="line542"></a>        <span style="color: #666666; font-style: italic;">// Twitter will disconnect on error, but we want to consume the rest of the response body (which is useful)</span>
<a name="line543"></a>        <span style="color: #b1b100;">while</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$bLine</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/trim"><span style="color: #990000;">trim</span></a><span style="color: #009900;">&#40;</span><a href="http://www.php.net/fgets"><span style="color: #990000;">fgets</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">4096</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line544"></a>          <span style="color: #000088;">$respBody</span> <span style="color: #339933;">.=</span> <span style="color: #000088;">$bLine</span><span style="color: #339933;">;</span>
<a name="line545"></a>        <span style="color: #009900;">&#125;</span>
<a name="line546"></a>&nbsp;
<a name="line547"></a>        <span style="color: #666666; font-style: italic;">// Construct error</span>
<a name="line548"></a>        <span style="color: #000088;">$errStr</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">'HTTP ERROR '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$httpCode</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">': '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$httpMessage</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">' ('</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$respBody</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">')'</span><span style="color: #339933;">;</span>
<a name="line549"></a>&nbsp;
<a name="line550"></a>        <span style="color: #666666; font-style: italic;">// Set last error state</span>
<a name="line551"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">lastErrorMsg</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$errStr</span><span style="color: #339933;">;</span>
<a name="line552"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">lastErrorNo</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$httpCode</span><span style="color: #339933;">;</span>
<a name="line553"></a>&nbsp;
<a name="line554"></a>        <span style="color: #666666; font-style: italic;">// Have we exceeded maximum failures?</span>
<a name="line555"></a>        <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$connectFailures</span> <span style="color: #339933;">&gt;</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">connectFailuresMax</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line556"></a>          <span style="color: #000088;">$msg</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">'Connection failure limit exceeded with '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$connectFailures</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">' failures. Last error: '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$errStr</span><span style="color: #339933;">;</span>
<a name="line557"></a>          <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$msg</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line558"></a>          <span style="color: #b1b100;">throw</span> <span style="color: #000000; font-weight: bold;">new</span> PhirehoseConnectLimitExceeded<span style="color: #009900;">&#40;</span><span style="color: #000088;">$msg</span><span style="color: #339933;">,</span> <span style="color: #000088;">$httpCode</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// We eventually throw an exception for other code to handle</span>
<a name="line559"></a>        <span style="color: #009900;">&#125;</span>
<a name="line560"></a>        <span style="color: #666666; font-style: italic;">// Increase retry/backoff up to max</span>
<a name="line561"></a>        <span style="color: #000088;">$httpRetry</span> <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$httpRetry</span> <span style="color: #339933;">&lt;</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">HTTP_BACKOFF_MAX</span><span style="color: #009900;">&#41;</span> ? <span style="color: #000088;">$httpRetry</span> <span style="color: #339933;">*</span> <span style="color: #cc66cc;">2</span> <span style="color: #339933;">:</span> <span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">HTTP_BACKOFF_MAX</span><span style="color: #339933;">;</span>
<a name="line562"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'HTTP failure '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$connectFailures</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">' of '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">connectFailuresMax</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">' connecting to stream: '</span> <span style="color: #339933;">.</span>
<a name="line563"></a>          <span style="color: #000088;">$errStr</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">'. Sleeping for '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$httpRetry</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">' seconds.'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line564"></a>        <a href="http://www.php.net/sleep"><span style="color: #990000;">sleep</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$httpRetry</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line565"></a>        <span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span>
<a name="line566"></a>&nbsp;
<a name="line567"></a>      <span style="color: #009900;">&#125;</span> <span style="color: #666666; font-style: italic;">// End if not http 200</span>
<a name="line568"></a>&nbsp;
<a name="line569"></a>      <span style="color: #666666; font-style: italic;">// Loop until connected OK</span>
<a name="line570"></a>    <span style="color: #009900;">&#125;</span> <span style="color: #b1b100;">while</span> <span style="color: #009900;">&#40;</span><span style="color: #339933;">!</span><a href="http://www.php.net/is_resource"><span style="color: #990000;">is_resource</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">||</span> <span style="color: #000088;">$httpCode</span> <span style="color: #339933;">!=</span> <span style="color: #cc66cc;">200</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line571"></a>&nbsp;
<a name="line572"></a>    <span style="color: #666666; font-style: italic;">// Connected OK, reset connect failures</span>
<a name="line573"></a>    <span style="color: #000088;">$connectFailures</span> <span style="color: #339933;">=</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span>
<a name="line574"></a>    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">lastErrorMsg</span> <span style="color: #339933;">=</span> <span style="color: #009900; font-weight: bold;">NULL</span><span style="color: #339933;">;</span>
<a name="line575"></a>    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">lastErrorNo</span> <span style="color: #339933;">=</span> <span style="color: #009900; font-weight: bold;">NULL</span><span style="color: #339933;">;</span>
<a name="line576"></a>&nbsp;
<a name="line577"></a>    <span style="color: #666666; font-style: italic;">// Switch to non-blocking to consume the stream (important)</span>
<a name="line578"></a>    <a href="http://www.php.net/stream_set_blocking"><span style="color: #990000;">stream_set_blocking</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">0</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line579"></a>&nbsp;
<a name="line580"></a>    <span style="color: #666666; font-style: italic;">// Connect always causes the filterChanged status to be cleared</span>
<a name="line581"></a>    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">filterChanged</span> <span style="color: #339933;">=</span> <span style="color: #009900; font-weight: bold;">FALSE</span><span style="color: #339933;">;</span>
<a name="line582"></a>&nbsp;
<a name="line583"></a>    <span style="color: #666666; font-style: italic;">// Flush stream buffer &amp; (re)assign fdrPool (for reconnect)</span>
<a name="line584"></a>    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">fdrPool</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line585"></a>    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">buff</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">''</span><span style="color: #339933;">;</span>
<a name="line586"></a>&nbsp;
<a name="line587"></a>  <span style="color: #009900;">&#125;</span>
<a name="line588"></a>&nbsp;
<a name="line589"></a>	<span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000000; font-weight: bold;">function</span> getAuthorizationHeader<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
<a name="line590"></a>	<span style="color: #009900;">&#123;</span>
<a name="line591"></a>		<span style="color: #000088;">$authCredentials</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/base64_encode"><span style="color: #990000;">base64_encode</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">username</span> <span style="color: #339933;">.</span> <span style="color: #0000ff;">':'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">password</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line592"></a>		<span style="color: #b1b100;">return</span> <span style="color: #0000ff;">&quot;Basic: &quot;</span><span style="color: #339933;">.</span><span style="color: #000088;">$authCredentials</span><span style="color: #339933;">;</span>
<a name="line593"></a>	<span style="color: #009900;">&#125;</span>
<a name="line594"></a>&nbsp;
<a name="line595"></a>  <span style="color: #009933; font-style: italic;">/**
<a name="line596"></a>   * Method called as frequently as practical (every 5+ seconds) that is responsible for checking if filter predicates
<a name="line597"></a>   * (ie: track words or follow IDs) have changed. If they have, they should be set using the setTrack() and setFollow()
<a name="line598"></a>   * methods respectively within the overridden implementation.
<a name="line599"></a>   *
<a name="line600"></a>   * Note that even if predicates are changed every 5 seconds, an actual reconnect will not happen more frequently than
<a name="line601"></a>   * every 2 minutes (as per Twitter Streaming API documentation).
<a name="line602"></a>   *
<a name="line603"></a>   * Note also that this method is called upon every connect attempt, so if your predicates are causing connection
<a name="line604"></a>   * errors, they should be checked here and corrected.
<a name="line605"></a>   *
<a name="line606"></a>   * This should be implemented/overridden in any subclass implementing the FILTER method.
<a name="line607"></a>   *
<a name="line608"></a>   * @see setTrack()
<a name="line609"></a>   * @see setFollow()
<a name="line610"></a>   * @see Phirehose::METHOD_FILTER
<a name="line611"></a>   */</span>
<a name="line612"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000000; font-weight: bold;">function</span> checkFilterPredicates<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
<a name="line613"></a>  <span style="color: #009900;">&#123;</span>
<a name="line614"></a>    <span style="color: #666666; font-style: italic;">// Override in subclass</span>
<a name="line615"></a>  <span style="color: #009900;">&#125;</span>
<a name="line616"></a>&nbsp;
<a name="line617"></a>  <span style="color: #009933; font-style: italic;">/**
<a name="line618"></a>   * Basic log function that outputs logging to the standard error_log() handler. This should generally be overridden
<a name="line619"></a>   * to suit the application environment.
<a name="line620"></a>   *
<a name="line621"></a>   * @see error_log()
<a name="line622"></a>   * @param string $messages
<a name="line623"></a>   */</span>
<a name="line624"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000000; font-weight: bold;">function</span> <a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$message</span><span style="color: #009900;">&#41;</span>
<a name="line625"></a>  <span style="color: #009900;">&#123;</span>
<a name="line626"></a>    <span style="color: #339933;">@</span><a href="http://www.php.net/error_log"><span style="color: #990000;">error_log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Phirehose: '</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$message</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">0</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line627"></a>  <span style="color: #009900;">&#125;</span>
<a name="line628"></a>&nbsp;
<a name="line629"></a>  <span style="color: #009933; font-style: italic;">/**
<a name="line630"></a>   * Performs forcible disconnect from stream (if connected) and cleanup.
<a name="line631"></a>   */</span>
<a name="line632"></a>  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000000; font-weight: bold;">function</span> disconnect<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
<a name="line633"></a>  <span style="color: #009900;">&#123;</span>
<a name="line634"></a>    <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><a href="http://www.php.net/is_resource"><span style="color: #990000;">is_resource</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<a name="line635"></a>      <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><a href="http://www.php.net/log"><span style="color: #990000;">log</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Closing Phirehose connection.'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line636"></a>      <a href="http://www.php.net/fclose"><span style="color: #990000;">fclose</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line637"></a>    <span style="color: #009900;">&#125;</span>
<a name="line638"></a>    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">conn</span> <span style="color: #339933;">=</span> <span style="color: #009900; font-weight: bold;">NULL</span><span style="color: #339933;">;</span>
<a name="line639"></a>    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">reconnect</span> <span style="color: #339933;">=</span> <span style="color: #009900; font-weight: bold;">FALSE</span><span style="color: #339933;">;</span>
<a name="line640"></a>  <span style="color: #009900;">&#125;</span>
<a name="line641"></a>&nbsp;
<a name="line642"></a>  <span style="color: #009933; font-style: italic;">/**
<a name="line643"></a>   * Reconnects as quickly as possible. Should be called whenever a reconnect is required rather that connect/disconnect
<a name="line644"></a>   * to preserve streams reconnect state
<a name="line645"></a>   */</span>
<a name="line646"></a>  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000000; font-weight: bold;">function</span> reconnect<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
<a name="line647"></a>  <span style="color: #009900;">&#123;</span>
<a name="line648"></a>    <span style="color: #000088;">$reconnect</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">reconnect</span><span style="color: #339933;">;</span>
<a name="line649"></a>    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">disconnect</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// Implicitly sets reconnect to FALSE</span>
<a name="line650"></a>    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">reconnect</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$reconnect</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// Restore state to prev</span>
<a name="line651"></a>    <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">connect</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line652"></a>  <span style="color: #009900;">&#125;</span>
<a name="line653"></a>&nbsp;
<a name="line654"></a>  <span style="color: #009933; font-style: italic;">/**
<a name="line655"></a>   * This is the one and only method that must be implemented additionally. As per the streaming API documentation,
<a name="line656"></a>   * statuses should NOT be processed within the same process that is performing collection
<a name="line657"></a>   *
<a name="line658"></a>   * @param string $status
<a name="line659"></a>   */</span>
<a name="line660"></a>  abstract <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> enqueueStatus<span style="color: #009900;">&#40;</span><span style="color: #000088;">$status</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line661"></a>&nbsp;
<a name="line662"></a>  <span style="color: #009933; font-style: italic;">/**
<a name="line663"></a>   * Reports a periodic heartbeat. Keep execution time minimal.
<a name="line664"></a>   *
<a name="line665"></a>   * @param array $data
<a name="line666"></a>   * @return NULL
<a name="line667"></a>   */</span>
<a name="line668"></a>  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> heartbeat<span style="color: #009900;">&#40;</span><a href="http://www.php.net/array"><span style="color: #990000;">array</span></a> <span style="color: #000088;">$data</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span><span style="color: #009900;">&#125;</span>
<a name="line669"></a>&nbsp;
<a name="line670"></a><span style="color: #009900;">&#125;</span> <span style="color: #666666; font-style: italic;">// End of class</span>
<a name="line671"></a>&nbsp;
<a name="line672"></a><span style="color: #000000; font-weight: bold;">class</span> PhirehoseException <span style="color: #000000; font-weight: bold;">extends</span> Exception <span style="color: #009900;">&#123;</span><span style="color: #009900;">&#125;</span>
<a name="line673"></a><span style="color: #000000; font-weight: bold;">class</span> PhirehoseNetworkException <span style="color: #000000; font-weight: bold;">extends</span> PhirehoseException <span style="color: #009900;">&#123;</span><span style="color: #009900;">&#125;</span>
<a name="line674"></a><span style="color: #000000; font-weight: bold;">class</span> PhirehoseConnectLimitExceeded <span style="color: #000000; font-weight: bold;">extends</span> PhirehoseException <span style="color: #009900;">&#123;</span><span style="color: #009900;">&#125;</span>
<a name="line675"></a>&nbsp;</pre>
<div class="header">
<h1>PHP Redis Fast</h1>
<ul>
<li><a href="../overview-summary.html">Overview</a></li>
<li>Package</li><li>Class</li><li>Tree</li><li><a href="../overview-files.html">Files</a></li>
<li><a href="../deprecated-list.html">Deprecated</a></li>
<li><a href="../todo-list.html">Todo</a></li>
<li><a href="../index-all.html">Index</a></li>
</ul>
</div>

<div class="small_links">
<a href="../index.html" target="_top">Frames</a>
<a href="../source\library\phirehose\lib\phirehose.php.html" target="_top">No frames</a>
</div>
<hr>

<p id="footer">This document was generated by <a href="http://peej.github.com/phpdoctor/">PHPDoctor: The PHP Documentation Creator</a></p>

</body>

</html>